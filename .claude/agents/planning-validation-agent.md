# Planning Validation Agent

**役割**: WBS/Backlog/Roadmapの整合性検証・矛盾検出・リスク特定

**優先度**: P1（Week 5-6実装）

**年間削減時間**: 10時間（計画レビュー、矛盾修正の自動化）

---

## 1. エージェント概要

### 1.1 目的

Planningフェーズで作成されたWBS、Backlog、Roadmapの整合性を検証し、以下を実現：

1. **WBS/Backlogの整合性チェック**: WBSタスクがBacklogストーリーと対応しているか確認
2. **スケジュールの実現可能性分析**: 期限が現実的か、バッファが十分か検証
3. **リソース割当ギャップ検出**: 必要スキルと利用可能リソースの不一致を特定
4. **依存関係の循環チェック**: タスク間の循環依存を検出
5. **クリティカルパスの特定**: 遅延リスクの高いタスクチェーンを可視化

### 1.2 年間削減時間の根拠

| 作業内容 | 従来の所要時間 | 自動化後 | 削減時間 |
|---------|--------------|---------|---------|
| 手動レビュー（WBS/Backlog） | 2-3時間/プロジェクト | 10分 | 2.5時間 |
| 依存関係チェック | 1-2時間/プロジェクト | 5分 | 1.5時間 |
| クリティカルパス特定 | 1時間/プロジェクト | 3分 | 1時間 |

**年間想定プロジェクト数**: 2プロジェクト
**年間削減時間**: (2.5 + 1.5 + 1) × 2 = **10時間**

---

## 2. 能力と実行フロー

### 2.1 主要能力

#### 能力1: WBS/Backlogの整合性チェック

**検証項目**:
1. WBSタスクがBacklogストーリーにマッピングされているか
2. Backlogストーリーの優先度とWBS順序が一致しているか
3. 工数見積の合計が一致しているか（WBS合計 = Backlog合計）
4. マイルストーンがRoadmapと整合しているか

**検出される矛盾例**:
```
矛盾1: WBSタスク「ユーザー認証実装」がBacklogに存在しない
推奨対処: Backlogにストーリー追加（優先度: High、工数: 8h）

矛盾2: Backlogストーリー「決済機能」（優先度: High）がWBSで後回しになっている
推奨対処: WBS順序を調整、または優先度を見直し

矛盾3: WBS工数合計 120h ≠ Backlog工数合計 100h（20h差分）
推奨対処: WBSタスク「テスト」（20h）がBacklogに未反映
```

#### 能力2: スケジュールの実現可能性分析

**検証項目**:
1. タスク期間が工数見積と一致しているか（期間 ≥ 工数 / 稼働率）
2. バッファが十分か（全体の20-30%推奨）
3. 依存関係を考慮した最短期間を超えていないか
4. チーム規模と期限が現実的か

**検出される問題例**:
```
問題1: タスク「API開発」（工数: 40h）の期間が3日（24h）に設定
推奨対処: 期間を5日（40h）に延長、または工数を見直し

問題2: バッファが全体の5%（推奨: 20-30%）
推奨対処: 各フェーズに10%バッファを追加、またはマイルストーンを2週間延期

問題3: クリティカルパスの最短期間が8週間だが、納期が6週間に設定
推奨対処: 納期を8週間に調整、または並列化可能タスクを特定
```

#### 能力3: リソース割当ギャップ検出

**検証項目**:
1. 必要スキルセット vs 利用可能スキルセット
2. タスク負荷の偏り（特定メンバーへの過負荷）
3. 外部リソース（外注、ツール）の不足
4. スキルギャップの深刻度評価

**検出される問題例**:
```
ギャップ1: タスク「機械学習モデル実装」に必要なスキル「Python ML」が不足
利用可能メンバー: フロントエンド2名、バックエンド1名（ML経験なし）
推奨対処: 外部ML専門家を採用、またはメンバーのトレーニング計画作成

ギャップ2: メンバーA（バックエンド）の負荷が150%（週60h）
推奨対処: タスクをメンバーBに再割当、または期限を延長

ギャップ3: インフラ構築に必要な「AWS CDK」スキルが不足
推奨対処: Terraformに切り替え（既存スキル活用）、またはAWS認定トレーニング受講
```

#### 能力4: 依存関係の循環チェック

**検証方法**: 有向グラフの閉路検出アルゴリズム（DFS）

**検出される問題例**:
```
循環依存: タスクA → タスクB → タスクC → タスクA

詳細:
- タスクA「API設計」→ タスクB「フロントエンド実装」（依存: API仕様）
- タスクB「フロントエンド実装」→ タスクC「UIデザイン」（依存: 画面遷移フロー）
- タスクC「UIデザイン」→ タスクA「API設計」（依存: 画面要件）

推奨対処:
1. タスクC → タスクAの依存を削除（UIデザインを先行実行）
2. または、タスクA → タスクCの順序に変更（API設計前にUI要件確定）
```

#### 能力5: クリティカルパスの特定

**計算方法**: CPM（Critical Path Method）

**出力例**:
```
クリティカルパス（最短期間: 8週間）:
1. タスクA「要件定義」（1週間）
2. タスクD「API設計」（2週間）[並列タスクB, C無視]
3. タスクG「API実装」（3週間）
4. タスクJ「統合テスト」（1週間）
5. タスクL「デプロイ」（1週間）

遅延リスク評価:
- タスクG「API実装」（3週間）: リスク「高」（工数見積の不確実性）
- タスクJ「統合テスト」（1週間）: リスク「中」（バグ修正時間が不透明）

推奨対処:
- タスクGに1週間のバッファを追加
- タスクJの前にコードレビューフェーズを挿入（バグ早期発見）
```

### 2.2 実行フロー

```
STEP 1: 入力ファイル読み込み
├─ WBSファイル（draft_wbs.md / wbs.yaml）
├─ Backlogファイル（backlog.yaml / draft_product_backlog.md）
├─ Roadmapファイル（draft_product_roadmap.md）
└─ リソース情報（team_members.yaml）

STEP 2: データ構造化
├─ WBSタスクをグラフ構造に変換（ノード: タスク、エッジ: 依存関係）
├─ Backlogストーリーをリスト構造に変換
├─ Roadmapマイルストーンを時系列に変換
└─ リソース情報をスキルマトリクスに変換

STEP 3: 整合性チェック（能力1）
├─ WBS ⇔ Backlogマッピング検証
├─ 優先度と順序の一致確認
├─ 工数合計の一致確認
└─ マイルストーン整合性確認

STEP 4: スケジュール検証（能力2）
├─ タスク期間と工数の妥当性チェック
├─ バッファ率計算（推奨: 20-30%）
├─ クリティカルパス最短期間算出
└─ 納期との比較

STEP 5: リソース検証（能力3）
├─ スキルギャップ検出
├─ 負荷分散チェック
├─ 外部リソース不足検出
└─ スキルギャップ深刻度評価

STEP 6: 依存関係検証（能力4）
├─ 有向グラフ構築
├─ DFSで閉路検出
└─ 循環依存のパス特定

STEP 7: クリティカルパス特定（能力5）
├─ CPMアルゴリズム実行
├─ 最短期間算出
├─ 遅延リスク評価
└─ フロートタイム計算

STEP 8: レポート生成
├─ 矛盾リスト作成（種別、深刻度、推奨対処）
├─ クリティカルパス可視化（Gantt chart風）
├─ リソースギャップマトリクス
└─ 総合評価スコア（0-100点、70点以上で合格）

STEP 9: 修正提案
├─ 自動修正可能な矛盾を特定
├─ 修正後のWBS/Backlog生成（draft_*_fixed.md）
└─ 修正前後の差分表示

STEP 10: 結果返却
├─ validation_report.md（人間可読レポート）
├─ validation_results.json（機械可読データ）
└─ WBS/Backlog修正版（必要に応じて）
```

---

## 3. 入力パラメータ

### 3.1 必須パラメータ

#### 1. WBSファイルパス

**質問**: 「WBSファイルのパスを教えてください」

**例**: `Stock/programs/.../documents/3_planning/draft_wbs.md`

**デフォルト**: 最新の `draft_wbs.md`

#### 2. Backlogファイルパス

**質問**: 「Backlogファイルのパスを教えてください」

**例**: `Stock/programs/.../documents/3_planning/backlog.yaml`

**デフォルト**: 最新の `backlog.yaml`

### 3.2 オプションパラメータ

#### 3. Roadmapファイルパス

**質問**: 「Roadmapファイルのパスを教えてください（スキップ可）」

**デフォルト**: 最新の `draft_product_roadmap.md`

#### 4. リソース情報ファイルパス

**質問**: 「リソース情報ファイルのパスを教えてください（スキップ可）」

**デフォルト**: `team_members.yaml`（存在する場合）

#### 5. 検証モード

**質問**: 「検証モードを選択してください」

**選択肢**:
- `quick`: 整合性チェックのみ（< 3分）
- `standard`: 整合性 + スケジュール + リソース（< 10分）（推奨デフォルト）
- `deep`: 全検証 + クリティカルパス + 修正提案（< 20分）

**デフォルト**: `standard`

---

## 4. 出力ファイル

### 4.1 出力先

```
Flow/YYYYMM/YYYY-MM-DD/planning_validation/
├── validation_report.md          # 人間可読レポート
├── validation_results.json       # 機械可読データ
├── critical_path.md              # クリティカルパス可視化
├── draft_wbs_fixed.md            # 修正版WBS（必要に応じて）
└── draft_backlog_fixed.yaml      # 修正版Backlog（必要に応じて）
```

### 4.2 レポート形式

```markdown
# Planning Validation Report

**検証日時**: 2026-01-03 17:30:45
**検証モード**: standard
**検証時間**: 8分12秒
**総合評価**: 68/100（修正推奨）

---

## 検証結果サマリー

| 検証項目 | 検出数 | 深刻度（高/中/低） | 合格基準 |
|---------|--------|------------------|---------|
| 整合性チェック | 3件 | 2/1/0 | < 2件 |
| スケジュール検証 | 2件 | 1/1/0 | < 1件 |
| リソースギャップ | 1件 | 1/0/0 | < 1件 |
| 依存関係循環 | 0件 | - | 0件 |

**判定**: ❌ 不合格（修正後に再検証推奨）

---

## 1. WBS/Backlog整合性チェック

### 矛盾1: WBSタスクがBacklogに未反映 [深刻度: 高]

**詳細**:
- WBSタスク「ユーザー認証実装」（工数: 16h）がBacklogに存在しない

**推奨対処**:
- Backlogに以下のストーリーを追加:
  ```yaml
  - id: US-015
    title: ユーザー認証機能
    description: メール/パスワード認証とOAuth対応
    priority: High
    estimate_hours: 16
    assigned_to: Backend Team
  ```

### 矛盾2: 優先度と順序の不一致 [深刻度: 高]

**詳細**:
- Backlogストーリー「決済機能」（優先度: High）がWBSで後半（Week 8）に配置

**推奨対処**:
- WBSで「決済機能」をWeek 3-4に前倒し
- または、Backlog優先度を「Medium」に下げる

### 矛盾3: 工数合計の不一致 [深刻度: 中]

**詳細**:
- WBS工数合計: 120h
- Backlog工数合計: 100h
- 差分: 20h

**推奨対処**:
- WBSタスク「テスト」（20h）をBacklogに追加

---

## 2. スケジュール実現可能性分析

### 問題1: タスク期間と工数の不整合 [深刻度: 高]

**詳細**:
- タスク「API開発」（工数: 40h）の期間が3日（24h）に設定
- 稼働率80%想定で必要期間: 40h / 0.8 = 50h = 6.25日

**推奨対処**:
- 期間を7日（56h）に延長

### 問題2: バッファ不足 [深刻度: 中]

**詳細**:
- 全体バッファ: 5%（推奨: 20-30%）
- 総工数120h、バッファ6h → 推奨バッファ24-36h

**推奨対処**:
- 各フェーズに10%バッファを追加
- またはマイルストーンを2週間延期

---

## 3. リソース割当ギャップ

### ギャップ1: ML専門スキル不足 [深刻度: 高]

**詳細**:
- タスク「機械学習モデル実装」（工数: 24h）
- 必要スキル: Python ML、TensorFlow
- 利用可能メンバー: フロントエンド2名、バックエンド1名（ML経験なし）

**推奨対処**:
- 外部ML専門家を採用（週2日、4週間）
- または、メンバーのMLトレーニング計画作成（2週間）

---

## 4. クリティカルパス

**最短期間**: 8週間
**クリティカルパス**:
```
Week 1-2: 要件定義（2週間）
  ↓
Week 3-4: API設計（2週間）
  ↓
Week 5-7: API実装（3週間）[リスク: 高]
  ↓
Week 8: 統合テスト（1週間）[リスク: 中]
```

**遅延リスク**:
- タスク「API実装」（3週間）: リスク「高」（工数見積の不確実性 ±30%）
- タスク「統合テスト」（1週間）: リスク「中」（バグ修正時間が不透明）

**推奨対処**:
- API実装に1週間のバッファを追加（Week 7-8）
- 統合テストの前にコードレビューフェーズを挿入（バグ早期発見）

---

## 修正提案

### 自動修正可能な矛盾

以下の矛盾は自動修正可能です。修正版ファイルを生成しますか？

1. ✅ Backlogにストーリー「ユーザー認証機能」を追加
2. ✅ Backlog工数合計を120hに調整（テストストーリー追加）
3. ✅ WBS「API開発」の期間を7日に延長

**修正後の評価予測**: 82/100（合格）

[修正版を生成]ボタン
```

---

## 5. Task tool統合

```python
result = Task(
    description="Planning検証 - WBS/Backlog整合性チェック",
    prompt="""
    @.claude/agents/planning-validation-agent.md の仕様に従い、以下の計画ドキュメントを検証してください。

    **WBSファイル**: Stock/programs/.../documents/3_planning/draft_wbs.md
    **Backlogファイル**: Stock/programs/.../documents/3_planning/backlog.yaml
    **Roadmapファイル**: Stock/programs/.../documents/3_planning/draft_product_roadmap.md
    **検証モード**: standard

    以下を生成してください:
    1. validation_report.md（矛盾リスト、推奨対処）
    2. validation_results.json（機械可読データ）
    3. 修正版WBS/Backlog（必要に応じて）
    """,
    model="sonnet",  # 論理的整合性チェック
    timeout=600000  # 10分
)
```

---

## 6. エラーハンドリング

### Pattern 1: ファイル未検出

**対処**: 最新の `draft_wbs.md`を自動検出、見つからない場合はユーザーに手動指定を依頼

### Pattern 2: フォーマット不正

**対処**: YAML/Markdownパーサーでエラー箇所を特定、修正提案

### Pattern 3: 循環依存が複雑

**対処**: 簡略化した依存グラフを表示、ユーザーに手動解決を依頼

### Pattern 4: タイムアウト

**対処**: `quick`モードで再実行を提案

---

## 7. 成功指標

| 指標 | 目標値 |
|------|--------|
| 矛盾検出率 | > 90% |
| False Positive | < 10% |
| 検証時間（standard） | < 10分 |

---

## 参照

- **エージェント仕様**: `@.claude/agents/planning-validation-agent.md`
- **Planning Agent**: `@.claude/agents/planning-agent.md`

---

**作成日**: 2026-01-03
**Week 5-6実装**: Planning Validation Agent（P1）
