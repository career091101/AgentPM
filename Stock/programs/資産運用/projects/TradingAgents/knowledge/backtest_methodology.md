# バックテスト方法論

## 概要

このドキュメントでは、agent-backtest-validatorが使用するバックテスト方法論について解説します。

---

## バイアス防止の3原則

### 1. ルックアヘッドバイアス（Look-Ahead Bias）防止

**定義**: 未来のデータを使用してしまうバイアス

**防止方法: ポイントインタイム原則**
```python
# ✅ 正しい例
for i in range(len(data)):
    available_data = data[:i+1]  # その日までのデータのみ使用
    sma = calculate_sma(available_data)

# ❌ 間違った例
sma = calculate_sma(data)  # 全データを一度に計算（未来データ使用）
for i in range(len(data)):
    signal = check_signal(data[i], sma[i])
```

**具体例**:
- 2020-01-01のトレード判定には、2020-01-01までのデータのみ使用
- 2020-01-02以降のデータは一切使用しない

### 2. サバイバーシップバイアス（Survivorship Bias）防止

**定義**: 現在存在する銘柄のみでバックテストを行い、上場廃止銘柄を除外するバイアス

**日経225での扱い**:
- 日経225は指数（銘柄入替あり）
- 指数そのものがバックテスト対象のため、サバイバーシップバイアスの影響なし

**注意点**:
- 個別銘柄のバックテストでは必須の対策
- ETFや指数先物では基本的に該当しない

### 3. オーバーフィッティング（Over-Fitting）防止

**定義**: 過去データに過度に適合し、未来のデータで性能が低下する現象

**防止方法**:

#### データ分割（60/20/20）
```
全データ（5年、1,250営業日）
├── Training（60%、750日）: パラメータ最適化
├── Validation（20%、250日）: 検証
└── Test（20%、250日）: 最終評価
```

**重要**: Test期間のデータは一切見ずに、最後に1回だけ評価

#### パラメータ数の制限
- **最大5個まで**: パラメータが多いほどオーバーフィッティングのリスク大
- 例: SMA期間、RSI期間、エントリー閾値、利益確定閾値、ストップロス閾値

#### ウォークフォワード分析
後述の「ウォークフォワード分析」セクション参照

---

## データ分割の詳細

### Training期間（60%）
**用途**: パラメータ最適化

**期間**: 2020-01-01 ~ 2023-06-30（約750日）

**実施内容**:
- 各指標のパラメータ調整
- エントリー/エグジットロジックの調整
- 複数の戦略候補から最良のものを選択

### Validation期間（20%）
**用途**: 検証、早期停止

**期間**: 2023-07-01 ~ 2024-06-30（約250日）

**実施内容**:
- Training期間で最適化したパラメータの検証
- オーバーフィッティングの早期検出
- パラメータの微調整

### Test期間（20%）
**用途**: 最終評価（1回のみ）

**期間**: 2024-07-01 ~ 2025-12-31（約250日）

**重要ルール**:
- **Test期間のデータは一切見ない**
- Training/Validationで決定したパラメータをそのまま適用
- 評価は1回のみ（複数回評価するとオーバーフィッティング）

---

## ウォークフォワード分析

### 目的
オーバーフィッティングの検出と、異なる市場環境での戦略の堅牢性確認

### 方法
**6ヶ月訓練 → 1ヶ月テスト × 30期間**

```
期間1: [Train: 2020-01 ~ 2020-06] → [Test: 2020-07]
期間2: [Train: 2020-02 ~ 2020-07] → [Test: 2020-08]
期間3: [Train: 2020-03 ~ 2020-08] → [Test: 2020-09]
...
期間30: [Train: 2022-07 ~ 2022-12] → [Test: 2023-01]
```

### WF効率の計算
```
WF効率 = (平均Test期間シャープレシオ / 平均Train期間シャープレシオ) × 100
```

**合格基準**: WF効率 ≥ 50%

**解釈**:
- **100%**: Train期間とTest期間で同等のパフォーマンス（理想的）
- **50-100%**: 許容範囲（Train期間より性能低下するが実用可能）
- **< 50%**: オーバーフィッティングの疑い（戦略不採用）

### 例
```
平均Train期間シャープレシオ: 1.50
平均Test期間シャープレシオ: 0.90
WF効率 = (0.90 / 1.50) × 100 = 60% ✅ 合格
```

---

## マーケットレジーム別評価

### 目的
異なる市場環境で戦略が機能することを確認

### レジーム定義

#### Bull Market（上昇相場）
**定義**: SMA50 > SMA200 AND ATR < 3%
**特徴**: 安定した上昇トレンド

#### Bear Market（下降相場）
**定義**: SMA50 < SMA200 AND ATR < 3%
**特徴**: 安定した下降トレンド

#### Sideways（レンジ相場）
**定義**: 価格変動幅 < 5%（20日間）
**特徴**: 明確なトレンドなし

#### High Volatility（高ボラティリティ）
**定義**: ATR ≥ 3%
**特徴**: 急激な価格変動

### 合格基準
**全レジームでシャープレシオ > 0.3**

**理由**:
- 特定のレジームでのみ機能する戦略は実用性低
- 全レジームで一定以上のパフォーマンスが必要

---

## パフォーマンス指標

### シャープレシオ（Sharpe Ratio）

**計算式**:
```
シャープレシオ = (平均リターン - 無リスク利子率) / リターンの標準偏差
```

**簡易計算**（無リスク利子率=0と仮定）:
```
シャープレシオ = 平均リターン / リターンの標準偏差
```

**解釈**:
- **> 2.0**: 優秀
- **1.0-2.0**: 良好
- **0.5-1.0**: 許容範囲
- **< 0.5**: 不十分

**合格基準**: Test期間で ≥ 1.0

### 最大ドローダウン（Maximum Drawdown）

**定義**: 累積リターンの最高値から最低値までの最大下落幅

**計算**:
```python
cumulative_returns = []
cumulative = 0
for trade in trades:
    cumulative += trade['profit_loss']
    cumulative_returns.append(cumulative)

max_dd = 0
peak = cumulative_returns[0]
for cum_return in cumulative_returns:
    if cum_return > peak:
        peak = cum_return
    dd = peak - cum_return
    if dd > max_dd:
        max_dd = dd
```

**許容範囲**:
- **< 10%**: 優秀
- **10-20%**: 良好
- **20-30%**: 許容範囲
- **> 30%**: リスク大

### 勝率（Win Rate）

**計算式**:
```
勝率 = (勝ちトレード数 / 総トレード数) × 100
```

**注意点**:
- 勝率が高くても、平均損失 > 平均利益なら損失
- 勝率とリスク・リワード比率の両方を考慮

### 平均R:R比率

**計算式**:
```
平均R:R = 平均利益 / 平均損失
```

**例**:
- 平均利益: +3.0%
- 平均損失: -1.5%
- R:R = 3.0 / 1.5 = 2.0（1:2）

---

## バックテスト実行の注意点

### 1. スリッページ考慮
実際のトレードでは、指定価格で約定しない場合がある
→ バックテストでは0.1-0.2%のスリッページを想定

### 2. 手数料考慮
先物取引の手数料を考慮
→ 日経225先物: 片道約400円/枚

### 3. 流動性制約
大口注文では価格が不利に動く
→ 日経225先物は流動性高いため、基本的に問題なし

### 4. 時間帯考慮
24時間取引だが、日中取引とナイトセッションで流動性が異なる

---

## 合格基準まとめ

| 項目 | 基準 | 重要度 |
|-----|------|--------|
| Test期間シャープレシオ | ≥ 1.0 | 必須 |
| WF効率 | ≥ 50% | 必須 |
| 全レジームシャープレシオ | > 0.3 | 必須 |
| 最大ドローダウン | < 30% | 推奨 |
| 総トレード数 | ≥ 30 | 推奨 |

**総合判定**: 必須3項目すべてクリアで「合格」

---

## 参考文献

- Evidence-Based Technical Analysis - David Aronson
- Quantitative Trading - Ernie Chan
- Advances in Financial Machine Learning - Marcos Lopez de Prado
