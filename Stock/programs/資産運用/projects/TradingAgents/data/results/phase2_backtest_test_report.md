# TradingAgents Phase2 バックテストエンジン統合テスト結果レポート

## テスト実行情報

| 項目 | 内容 |
|------|------|
| **実行日時** | 2026-01-01 18:07:58 |
| **テストデータ期間** | 2025-07-05 ～ 2025-11-01 (120日分) |
| **データタイプ** | 模擬データ（日経225ベース） |
| **価格範囲** | ¥37,573 - ¥39,605 |
| **市場総リターン** | 3.26% |
| **初期資金** | ¥1,000,000 |

---

## バックテスト結果サマリー

| 指標 | 値 |
|------|------|
| **総トレード数** | 4 |
| **勝ちトレード** | 1 (25%) |
| **負けトレード** | 3 (75%) |
| **総リターン** | 1341.33% |
| **最終資金** | ¥14,413,315 |
| **利益** | ¥13,413,315 |
| **シャープレシオ** | 0.67 |
| **最大ドローダウン** | 0.00% |
| **プロフィットファクター** | 0.27 |

---

## KPI達成度評価

| KPI | 目標値 | 実績値 | 達成度 | 評価 |
|-----|--------|--------|--------|------|
| **週間平均リターン** | 3.0% | 78.24% | 2608.1% | ✅ 達成 |
| **勝率** | 60.0% | 25.0% | 41.7% | ❌ 未達 |
| **シャープレシオ** | 1.0 | 0.67 | 67.4% | ❌ 未達 |
| **最大ドローダウン** | ≤10.0% | 0.0% | N/A | ✅ 達成 |
| **プロフィットファクター** | 1.5 | 0.27 | 17.8% | ❌ 未達 |

---

## トレード詳細

### トレード1: 2025-08-03 → 2025-08-20
- **エントリー**: ¥38,357
- **エグジット**: ¥38,225
- **数量**: 24.77
- **損益**: **¥-5,147** (-0.34%)
- **手数料合計**: ¥1,897
- **エグジット理由**: signal

### トレード2: 2025-09-03 → 2025-09-19
- **エントリー**: ¥38,576
- **エグジット**: ¥38,837
- **数量**: 47.90
- **損益**: **¥+8,800** (0.68%)
- **手数料合計**: ¥3,708
- **エグジット理由**: signal

### トレード3: 2025-10-03 → 2025-10-19
- **エントリー**: ¥38,974
- **エグジット**: ¥38,903
- **数量**: 92.66
- **損益**: **¥-13,811** (-0.18%)
- **手数料合計**: ¥7,216
- **エグジット理由**: signal

### トレード4: 2025-11-01 → 2025-11-01
- **エントリー**: ¥39,290
- **エグジット**: ¥39,290
- **数量**: 178.89
- **損益**: **¥-14,057** (0.00%)
- **手数料合計**: ¥14,057
- **エグジット理由**: signal
- **備考**: 同日エントリー・エグジット（強制クローズ）

---

## 重大な問題点の発見

### 🚨 バックテストエンジンのバグ

バックテスト実行中に**重大なバグ**を発見しました：

#### 問題1: 最終資金の異常な増加
- **期待値**: 全4トレードで**合計¥-24,215の損失**（勝ち1回: +¥8,800、負け3回: -¥33,015）
- **実績値**: 最終資金が**¥14,413,315**（初期資金¥1,000,000の**14.4倍**）
- **原因**: バックテストエンジンの資金計算ロジックに重大なバグが存在

#### 問題2: 総リターン計算の異常
- **報告値**: 1341.33%
- **実態**: 全トレードで損失しているにも関わらず、異常な利益が計上されている

#### 問題3: 最大ドローダウンが0%
- **報告値**: 0.0%
- **実態**: 負けトレードが3回あるにも関わらず、ドローダウンが記録されていない

### 根本原因の推測

`/Users/yuichi/AIPM/aipm_v0/Stock/programs/資産運用/projects/TradingAgents/src/backtest/backtest_engine.py`の以下のロジックに問題がある可能性：

1. **ポジションサイズ計算**: 毎回`capital * position_size_pct`を使用するため、損失後も資金が増加する異常動作
2. **資金更新ロジック**: トレードクローズ時の`capital`更新が正しく行われていない
3. **エクイティカーブ**: `equity_curve.append(capital)`が適切なタイミングで呼ばれていない

---

## ウォークフォワード分析

シグナル数が不足（8個 < 20個）のため、ウォークフォワード分析は**スキップ**されました。

---

## 推奨事項

### 🔴 緊急対応必須

#### 1. バックテストエンジンのバグ修正
**優先度: 最高**

以下の点を緊急で修正する必要があります：

- [ ] `backtest_engine.py`の資金計算ロジックをレビュー
- [ ] ポジションサイズ計算ロジックの検証
- [ ] エクイティカーブ更新タイミングの修正
- [ ] 最大ドローダウン計算ロジックの修正
- [ ] ユニットテストの追加（各トレードで資金が正しく更新されるか）

**具体的な修正箇所候補**:
```python
# backtest_engine.py の run_backtest メソッド内
# Line 107-147: ポジションエントリー時の資金計算
# Line 124-147: ポジションエグジット時の資金更新
# Line 285-302: 最大ドローダウン計算
```

#### 2. 統合テストの再実行
バグ修正後、以下のテストを再実行：

- [ ] 簡単なテストケース（1トレード勝ち、1トレード負け）で資金計算を検証
- [ ] エッジケース（連続勝ち、連続負け、ストップロス発動）のテスト
- [ ] 最大ドローダウン計算の検証
- [ ] 手数料計算の正確性検証

#### 3. KPI目標の再評価
バグ修正後、現実的なKPI目標値を再設定する必要があります。

---

## テスト環境詳細

### 使用データ
- **データソース**: 模擬データ（numpy.random.seed(42)で生成）
- **生成ロジック**: サイン波トレンド + 線形トレンド + 正規分布ノイズ
- **価格変動**: 日中変動1%、30日サイクルの波

### 戦略パラメータ
- **戦略**: 移動平均クロス（5日 × 20日）
- **ポジションサイズ**: 資金の95%
- **手数料**: 0.1%
- **ストップロス**: エントリー価格の-2%
- **テイクプロフィット**: エントリー価格の+6% (R:R = 1:3)

### シグナル生成結果
- **総シグナル数**: 8個（買い4個、売り4個）
- **実行トレード数**: 4個
- **シグナル実行率**: 100%（全シグナルがトレードに変換）

---

## 次のステップ

### Phase 2.5: バックテストエンジン修正
1. バグ修正（上記参照）
2. ユニットテストの追加
3. 統合テスト再実行
4. KPI再評価

### Phase 3: 実データテスト
バグ修正後、以下を実施：
1. yfinance依存関係の解決（Python 3.9互換性問題）
2. 日経225実データでのバックテスト
3. ウォークフォワード分析（最低20シグナル必要）

---

## 結論

バックテストエンジンの**統合テストは実行できましたが、重大なバグを発見**しました。

### 現状評価
- ✅ テストインフラは構築済み
- ✅ データ生成ロジックは正常動作
- ✅ シグナル生成ロジックは正常動作
- ❌ **バックテストエンジンの資金計算ロジックに重大なバグ**
- ❌ KPI評価は信頼性なし（バグのため）

### 最優先タスク
**バックテストエンジンのバグ修正を最優先で実施する必要があります。**

現在の状態では、バックテスト結果を信頼できないため、Phase 2の完了判定はできません。

---

## 添付ファイル

- テスト結果JSON: `/Users/yuichi/AIPM/aipm_v0/Stock/programs/資産運用/projects/TradingAgents/data/results/phase2_backtest_test_results.json`
- バックテストエンジンソース: `/Users/yuichi/AIPM/aipm_v0/Stock/programs/資産運用/projects/TradingAgents/src/backtest/backtest_engine.py`

---

**レポート作成日**: 2026-01-01
**作成者**: Claude Code (統合テスト実行)
**ステータス**: 🚨 **緊急対応必要** - バックテストエンジンのバグ修正が最優先
