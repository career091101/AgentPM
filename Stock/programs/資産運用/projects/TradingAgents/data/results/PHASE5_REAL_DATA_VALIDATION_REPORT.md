# Phase 5 - 実データバックテスト検証レポート

**生成日時**: 2026-01-01
**検証期間**: 2020-01-01 ～ 2025-12-31 (5年間)
**実行環境**: Python 3.9.6 (yfinance互換性制限のため、サンプルデータ使用)

---

## エグゼクティブサマリー

Phase 4で構築した検証基盤を用いて、日経225相当の5年間データでの包括的バックテストを実施しました。

### 実施項目
- ✅ 基本バックテスト（Train/Test分割）- **完了**
- ✅ レジーム別最適化バックテスト - **完了**
- ⚠️ Walk-forward分析 - **部分実装**（戦略関数インターフェース調整が必要）
- ✅ 統合レポート作成 - **完了**

### 環境制約事項
- **Python 3.9.6**: yfinance 1.0はPython 3.10+の型ヒント構文を使用しており、実データ取得時にTypeErrorが発生
- **対応策**: サンプルデータ生成関数を使用し、実データと同様の特性（ドリフト、ボラティリティ、トレンド）を持つ1566営業日分のデータで代替
- **本番移行時の推奨**: Python 3.10+環境でyfinanceを使用し、実データ再検証を実施

---

## 1. データ取得状況

### サンプルデータ仕様
- **期間**: 2020-01-01 ～ 2025-12-31
- **データポイント数**: 1566営業日
- **初期価格**: ¥23,000
- **最終価格範囲**: ¥19,557 ～ ¥132,375
- **年率ドリフト**: 約0.02%/日
- **年率ボラティリティ**: 約1.5%/日
- **トレンド成分**: 5年間で+30%の上昇トレンド

### データ完全性
- ✅ 欠損値: 0件
- ✅ OHLC関係: 全データで妥当（H ≥ max(O,C), L ≤ min(O,C)）
- ✅ 出来高: 100M～300M株の範囲でランダム生成

---

## 2. 基本バックテスト結果

### 全期間パフォーマンス（2020-2025）

| KPI | 値 | Phase 4標準目標 | 評価 |
|-----|-----|----------------|------|
| 総トレード数 | 15 | - | - |
| 勝率 | 40.00% | 55% | ❌ |
| 総リターン | -0.57% | - | ❌ |
| Sharpe ratio | 0.14 | 0.65 | ❌ |
| 最大DD | -6.13% | -10% | ✅ |
| 最終資産 | ¥9,943,234 | - | ❌ |

### Train期間（2020-2022）

| KPI | 値 |
|-----|-----|
| データポイント | 783日 |
| 総トレード数 | 9 |
| 勝率 | 44.44% |
| 総リターン | +0.79% |
| Sharpe ratio | 0.41 |
| 最大DD | -6.13% |
| 最終資産 | ¥10,078,876 |

### Test期間（2023-2025）

| KPI | 値 |
|-----|-----|
| データポイント | 783日 |
| 総トレード数 | 6 |
| 勝率 | 33.33% |
| 総リターン | -1.35% |
| Sharpe ratio | -0.21 |
| 最大DD | -4.13% |
| 最終資産 | ¥9,865,420 |

### Overfitting評価

| メトリクス | Train | Test | 乖離率 | 評価 |
|-----------|-------|------|--------|------|
| Sharpe ratio | 0.41 | -0.21 | **-150.64%** | ❌ FAIL |
| 総リターン | +0.79% | -1.35% | **-270.62%** | ❌ FAIL |
| 勝率 | 44.44% | 33.33% | -25.00% | ⚠️ |

**判定**: **Train-Test乖離が目標30%を大幅超過し、重大なOverfittingを検出**

---

## 3. レジーム別分析結果

### レジーム検出統計

| レジーム | 日数 | 比率 |
|---------|------|------|
| BULL | 793日 | 51.1% |
| SIDEWAYS | 484日 | 31.2% |
| BEAR | 89日 | 5.7% |
| 不明 | 200日 | 12.0% |
| **合計** | **1566日** | **100%** |

**レジーム切り替え回数**: 35回

### レジーム別最適パラメータ

#### BULL Market
```yaml
ma_short: 10
ma_long: 30
rsi_oversold: 25
rsi_overbought: 65
position_size_pct: 0.9
stop_loss_pct: 0.015
```

#### BEAR Market
```yaml
ma_short: 20
ma_long: 50
rsi_oversold: 20
rsi_overbought: 70
position_size_pct: 0.7
stop_loss_pct: 0.01
```

#### SIDEWAYS Market
```yaml
bb_period: 15
bb_std: 1.5
rsi_oversold: 25
rsi_overbought: 65
position_size_pct: 0.8
stop_loss_pct: 0.015
```

### 固定戦略 vs 動的切り替え戦略

| メトリクス | 固定戦略 | 動的戦略 | 改善率 | 評価 |
|-----------|---------|---------|--------|------|
| Sharpe ratio | 0.137 | -0.330 | **-339.96%** | ❌ |
| 総リターン | -1.98% | -21.79% | **-1002.46%** | ❌ |
| 勝率 | 40.00% | 34.62% | -13.46% | ❌ |
| 最大DD | -6.40% | -24.10% | +276.47% | ❌ |

**判定**: **動的切り替え戦略が固定戦略より大幅に劣化**
- レジーム検出精度の問題
- パラメータ過最適化
- 切り替えコスト（スリッページ、手数料）の影響

---

## 4. Walk-Forward分析結果

### 実装状況
- ⚠️ **部分実装完了**: WalkForwardAnalyzerモジュールは存在するが、戦略関数のインターフェースが不一致
- **課題**: 戦略関数は`List[Dict]`のシグナルを返す必要があるが、現在の`simple_ma_strategy`は`Dict`のKPIを返す設計
- **次のアクション**: 戦略関数を修正し、シグナル生成→BacktestEngine実行のフローに統合

### 期待されるWalk-Forward設定（実装完了後）
- **Train期間**: 12ヶ月
- **Test期間**: 3ヶ月
- **ステップ**: 1ヶ月（約57ウィンドウ生成予定）
- **パラメータグリッド**:
  - `ma_short`: [10, 20, 30]
  - `ma_long`: [30, 50, 100]
  - `position_size_pct`: [0.7, 0.8, 0.9]
  - `stop_loss_pct`: [0.01, 0.02, 0.03]

---

## 5. Phase 4 KPI目標評価

### 標準KPI目標（Q50目標値）との比較

| KPI | Q50目標 | 実測値（Test） | 達成率 | 評価 |
|-----|---------|---------------|--------|------|
| Sharpe ratio | 0.65 | -0.21 | **-32.3%** | ❌ |
| 週間リターン | 2.0% | -1.35% (全期間) | **-67.5%** | ❌ |
| 勝率 | 55% | 33.33% | **60.6%** | ❌ |
| 最大DD | -10% | -4.13% | **141.3%** | ✅ |
| Profit factor | 1.4 | 推定0.8 | **57.1%** | ❌ |

**総合評価**: **5項目中1項目のみ達成（20%達成率）**

### 達成確率推定（Walk-Forward未実施のため暫定）
- Sharpe ratio ≥ 0.65: **推定 < 10%**
- 勝率 ≥ 55%: **推定 < 20%**
- 最大DD ≤ -10%: **推定 > 80%** ✅

---

## 6. 可視化（概要）

### Equity Curve
- Train期間: 緩やかな上昇（+0.79%）
- Test期間: 下落トレンド（-1.35%）
- **Train-Test境界で明確な性能劣化**

### Drawdown Chart
- Train最大DD: -6.13%（2022年中盤）
- Test最大DD: -4.13%（2024年後半）
- **DDは目標内だが、リターンがマイナスのため無意味**

### Regime Performance
- BULL期間: わずかにプラス
- SIDEWAYS期間: 横ばい
- BEAR期間: 大幅マイナス
- **動的戦略はBEAR期間での損失拡大が原因**

---

## 7. 結論と推奨事項

### 主要発見事項

#### ✅ 成功したこと
1. **バックテスト基盤の動作確認**: Phase 3で構築したBacktestEngineは安定動作
2. **レジーム検出機能**: MarketRegimeDetectorは35回のレジーム切り替えを検出
3. **リスク管理**: 最大DDは目標-10%以内に収まる
4. **報告基盤**: 自動レポート生成が機能

#### ❌ 失敗したこと / 課題
1. **重大なOverfitting**: Train-Test乖離が-150%～-270%で目標30%を大幅超過
2. **動的戦略の劣化**: レジーム適応戦略が固定戦略より-340%悪化
3. **KPI目標未達**: 5項目中4項目で標準目標（Q50）未達成
4. **Walk-Forward未完**: 戦略関数インターフェースの不一致により実行不可

### レジーム別戦略の課題分析

**なぜ動的戦略が固定戦略より劣るのか？**
1. **レジーム誤検出**: 短期間のノイズをレジーム変化と誤認
2. **パラメータ過最適化**: 各レジームでの最適パラメータがTrain期間に過適合
3. **切り替えコスト**: 35回の切り替えでスリッページ・手数料が累積
4. **サンプル不足**: BEAR期間は89日のみで最適化が不十分

### 実運用への推奨事項

#### ❌ **現状では実運用を推奨しない**

理由:
- Sharpe ratio < 0（リスク調整後リターンがマイナス）
- Test期間でマイナスリターン
- Overfittingが重大

#### ✅ **次のステップ（優先順位順）**

1. **戦略の根本的見直し**
   - SMA単純クロスオーバーは効果薄。より堅牢な戦略（平均回帰、ブレイクアウト等）の検証
   - リスク管理の強化（トレーリングストップ、ポジションサイジング改善）

2. **Python 3.10+環境への移行**
   - yfinanceで実データ取得
   - サンプルデータではなく実データで再検証

3. **Walk-Forward分析の完了**
   - 戦略関数をシグナル生成型に修正
   - 57ウィンドウでの統計的評価を実施
   - Overfitting度合いを定量化

4. **レジーム検出の精度向上**
   - より長期のトレンド判定（20日→60日等）
   - マルチタイムフレーム分析（日足+週足）
   - 誤検出ペナルティの導入

5. **KPIターゲットの再設定**
   - 現実的な目標値への修正（Sharpe 0.3～0.5等）
   - 市場環境に応じた動的目標設定

---

## 8. Phase 5検証結果サマリー

### 成功基準チェックリスト

| 項目 | 目標 | 実績 | 達成 |
|------|------|------|------|
| 実データ取得 | 1260営業日 | 1566日（サンプル） | ⚠️ |
| 基本バックテスト | Train/Test両方 | ✅ 完了 | ✅ |
| レジーム最適化 | Bull/Bear/Sideways | ✅ 完了 | ✅ |
| Walk-forward分析 | 全ウィンドウ | ⚠️ インターフェース不一致 | ❌ |
| 統合レポート | ✅ | ✅ 本レポート | ✅ |
| 正のリターン達成率 | 80%以上 | 0%（Test期間） | ❌ |
| Train-Test乖離 | 30%以内 | -150%～-270% | ❌ |
| Q50目標達成確率 | 50%±10% | 推定20% | ❌ |

**総合達成率**: **3/8項目 (37.5%)**

### Phase 5最終判定

🔴 **Phase 5: 部分的成功 / 実運用は時期尚早**

**理由**:
- バックテスト基盤の動作は確認できたが、戦略自体の性能が不十分
- Overfittingが重大で、本番環境での損失リスクが高い
- Walk-Forward分析未完により、統計的信頼性が不十分

**次フェーズへの移行条件**:
1. Sharpe ratio > 0.5（Test期間）
2. Train-Test乖離 < 30%
3. Walk-Forward全ウィンドウの80%以上で正のリターン
4. 実データでの再検証完了

---

## 付録A: 生成ファイル一覧

### Phase 5で生成されたレポート
- `/data/results/phase4_real_data_backtest_report_20260101_203129.md` - 基本バックテストレポート
- `/data/results/phase4_regime_optimization_report.md` - レジーム最適化レポート
- `/data/results/PHASE5_REAL_DATA_VALIDATION_REPORT.md` - **本統合レポート**

### 実装済みスクリプト
- `/scripts/run_real_data_backtest_demo.py` - 基本バックテスト（サンプルデータ対応）
- `/scripts/run_regime_backtest.py` - レジーム最適化（サンプルデータ対応、修正済み）
- `/scripts/run_walk_forward_analysis.py` - Walk-Forward分析（要修正）
- `/scripts/analyze_kpi_statistics.py` - KPI統計分析（Walk-Forward結果待ち）

### Phase 4実装モジュール（再利用）
- `/src/data/real_data_loader.py` (538行) - RealDataLoader
- `/src/strategy/regime_specific_optimizer.py` (376行)
- `/src/strategy/adaptive_strategy.py` (502行)
- `/src/backtest/walk_forward_analyzer.py` (505行)
- `/src/backtest/backtest_engine.py` (高信頼性、Phase 3検証済み)

---

## 付録B: エラーログと対応

### yfinance Python 3.9互換性問題
```
TypeError: unsupported operand type(s) for |: 'types.GenericAlias' and 'types.GenericAlias'
```
**原因**: yfinance 1.0はPython 3.10+の`list[Any] | list[CalendarQuery]`構文を使用
**対応**: サンプルデータ生成関数`generate_sample_nikkei_data()`を作成し代替

### Walk-Forward戦略関数インターフェース不一致
```
TypeError: string indices must be integers
```
**原因**: `simple_ma_strategy()`がKPI Dictを返すが、WalkForwardAnalyzerはシグナルListを期待
**対応**: 未解決（Phase 6で修正予定）

---

## 付録C: 次のアクション（Phase 6提案）

### Phase 6: 戦略改善と実データ再検証

#### 目標
- Sharpe ratio > 0.5（Test期間）
- Train-Test乖離 < 30%
- 実データでの検証完了

#### タスク
1. **環境移行**（1日）
   - Python 3.10+ venv作成
   - yfinanceで実データ取得
   - データキャッシュ構築

2. **戦略改善**（3日）
   - 平均回帰戦略の実装（RSI逆張り等）
   - トレンドフォロー戦略の実装（MACD、ATR等）
   - ポートフォリオ戦略（複数戦略の組み合わせ）

3. **Walk-Forward完成**（2日）
   - 戦略関数をシグナル生成型に修正
   - 57ウィンドウでの分析実行
   - KPI統計レポート生成

4. **最終検証**（1日）
   - Phase 5成功基準での再評価
   - 実運用可否判定
   - Phase 7（週次レポート自動化）への移行判断

---

**レポート終了**

---

**生成者**: Phase 5 Agent 1
**次のAgent**: Phase 5 Agent 2（週次レポート自動生成）は本Phase完了後に実施予定
**備考**: 実データ取得とWalk-Forward完成後、Phase 5 Agent 2/3との統合を推奨
