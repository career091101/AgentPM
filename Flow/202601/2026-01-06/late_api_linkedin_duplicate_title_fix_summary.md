# Late API LinkedIn投稿 - タイトル重複問題修正完了

## 修正日時
2026-01-06

## 修正内容

### 修正対象ファイル

#### 1. fix_late_api_multi_post.py
**場所**: `Stock/programs/副業/projects/SNS/scripts/fix_late_api_multi_post.py:67-71`

**修正内容**:
```python
# 【修正】本文1行目がタイトルと同じ場合は除去（タイトル重複防止）
body_lines = body_clean.split('\n')
if body_lines and body_lines[0].strip().rstrip('。！？') == title_clean.strip():
    # 1行目（タイトル重複）を除去
    body_clean = '\n'.join(body_lines[1:]).strip()
```

#### 2. late_api_post.py
**場所**: `Stock/programs/副業/projects/SNS/scripts/late_api_post.py:833-837`

**修正内容**:
```python
# 【修正】本文1行目がタイトルと同じ場合は除去（タイトル重複防止）
body_lines = body.split('\n')
if body_lines and body_lines[0].strip().rstrip('。！？') == title_clean.strip():
    # 1行目（タイトル重複）を除去
    body = '\n'.join(body_lines[1:]).strip()

# タイトルと本文を結合
full_content = f"{title_clean}\n\n{body}"
```

## 修正ロジック

### 処理フロー

1. **タイトルと本文を抽出**
   - 正規表現で `### タイトル` と `### 本文` を抽出

2. **Markdown装飾を除去**
   - `**太字**` → 通常テキスト
   - `- 箇条書き` → 通常テキスト
   - `1. 番号付きリスト` → 通常テキスト

3. **本文1行目の重複チェック（新規追加）**
   - 本文を行単位に分割
   - 1行目がタイトルと同じか比較（句点・感嘆符・疑問符を除いて比較）
   - 同じ場合は1行目を除去

4. **タイトルと本文を結合**
   - `full_content = title + "\n\n" + body`

### 句点除去ロジック

```python
body_lines[0].strip().rstrip('。！？') == title_clean.strip()
```

- **目的**: 本文1行目に句点がある場合でもタイトルと一致判定
- **例**:
  - タイトル: "OpenAIとNVIDIAが仕掛けた「200兆円の循環投資」、ITバブルの再来か"
  - 本文1行目: "OpenAIとNVIDIAが仕掛けた「200兆円の循環投資」、ITバブルの再来か。"
  - 比較: 句点を除去して比較 → 一致 → 1行目を除去

## テスト結果

### テストケース1: タイトル重複あり（実際のデータ）

**入力**:
```
### タイトル
**OpenAIとNVIDIAが仕掛けた「200兆円の循環投資」、ITバブルの再来か**

### 本文（1,195文字）

OpenAIとNVIDIAが仕掛けた「200兆円の循環投資」、ITバブルの再来か。

日本経済新聞が報じた衝撃のレポート。
```

**期待される出力**:
```
OpenAIとNVIDIAが仕掛けた「200兆円の循環投資」、ITバブルの再来か

日本経済新聞が報じた衝撃のレポート。
```

**実際の出力**: ✅ 期待通り
**タイトル出現回数**: 1回（期待値: 1回）

---

### テストケース2: タイトル重複なし（互換性確認）

**入力**:
```
### タイトル
**テストタイトル**

### 本文（100文字）

これは本文の1行目です。
これは本文の2行目です。
```

**期待される出力**:
```
テストタイトル

これは本文の1行目です。
これは本文の2行目です。
```

**実際の出力**: ✅ 期待通り
**1行目**: "テストタイトル"（期待値: "テストタイトル"）
**3行目**: "これは本文の1行目です。"（期待値: "これは本文の1行目です。"）

---

### テストケース3: タイトルに句点ありの重複

**入力**:
```
### タイトル
**AI時代の新常識**

### 本文（200文字）

AI時代の新常識。

多くの企業がAI導入を進めているが、成功しているのはごく一部だ。
```

**期待される出力**:
```
AI時代の新常識

多くの企業がAI導入を進めているが、成功しているのはごく一部だ。
```

**実際の出力**: ✅ 期待通り
**タイトル出現回数**: 1回（期待値: 1回）

---

### 総合結果
🎉 **全テスト合格（3/3）**

## 修正前後の比較

### 修正前（問題のある出力）

```
OpenAIとNVIDIAが仕掛けた「200兆円の循環投資」、ITバブルの再来か

OpenAIとNVIDIAが仕掛けた「200兆円の循環投資」、ITバブルの再来か。

日本経済新聞が報じた衝撃のレポート。
```

👆 **タイトルが2回表示される**

### 修正後（正しい出力）

```
OpenAIとNVIDIAが仕掛けた「200兆円の循環投資」、ITバブルの再来か

日本経済新聞が報じた衝撃のレポート。
```

👆 **タイトルが1回のみ表示される**

## 影響範囲

### 修正の影響を受けるスクリプト
1. `fix_late_api_multi_post.py` - 3案別々投稿スクリプト
2. `late_api_post.py` - Late API投稿共通ライブラリ（`extract_post_content()`）

### 既存データへの影響
- **影響なし**: 既存の投稿データ（`posts_generated_takano_*.md`）は変更不要
- **後方互換性**: タイトル重複なしのデータでも正常動作

## 次のアクション

### 1. 実際のLate API投稿で検証
```bash
# 修正版スクリプトで投稿テスト
cd Stock/programs/副業/projects/SNS
python3 scripts/fix_late_api_multi_post.py
```

### 2. Late APIダッシュボードで確認
- URL: https://getlate.dev/dashboard
- 確認項目: タイトルが1回のみ表示されているか

### 3. 本番環境での監視
- 今後の投稿でタイトル重複が発生しないかモニタリング
- 異常があれば即座に報告

## 関連ドキュメント

- 課題定義: `Flow/202601/2026-01-06/late_api_linkedin_duplicate_title_issue.md`
- 根本原因分析: `Flow/202601/2026-01-06/late_api_linkedin_duplicate_title_root_cause.md`
- テストスクリプト: `Flow/202601/2026-01-06/test_title_duplicate_fix.py`
- 修正サマリー（本ドキュメント）: `Flow/202601/2026-01-06/late_api_linkedin_duplicate_title_fix_summary.md`

---

**修正完了日**: 2026-01-06
**修正者**: Claude Code (Sonnet 4.5)
**テスト結果**: 🎉 全テスト合格（3/3）
**ステータス**: ✅ 修正完了、本番投稿テスト待ち
