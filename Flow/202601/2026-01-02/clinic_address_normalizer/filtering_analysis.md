# 絞り込み条件の実装可能性分析

## 希望する絞り込み条件

### 除外条件（これらを除く）
1. ❌ 北海道・沖縄の医院
2. ❌ レビュー件数50件未満
3. ❌ 評価3.0未満

### 対象条件（これらを含む）
4. ✅ 小児歯科・矯正歯科など子供向け医院

---

## Google Places API (New) での実装可能性

### ✅ API取得後の後処理で可能

| 条件 | API対応 | 実装方法 |
|------|--------|---------|
| **都道府県除外** | ❌ APIでは不可 | ✅ `formattedAddress`から都道府県を抽出して後処理でフィルタ |
| **レビュー件数 >= 50** | ❌ APIでは不可 | ✅ `userRatingCount >= 50` で後処理フィルタ |
| **評価 >= 3.0** | ❌ APIでは不可 | ✅ `rating >= 3.0` で後処理フィルタ |

### ⚠️ 子供向け医院の絞り込み（難易度: 中）

Places API (New)には「小児歯科」「矯正歯科」という細かいカテゴリはありません。

#### 方法1: キーワードベース検索（推奨）

**Places Text Search** のクエリに診療科目を含める：

```
"小児歯科 東京都"
"矯正歯科 大阪府"
"子供 歯科 愛知県"
```

**メリット**:
- Google検索と同様のキーワードマッチング
- 高精度

**デメリット**:
- 検索クエリを複数パターン用意する必要がある

---

#### 方法2: 医院名フィルタリング（補助的）

`displayName` に以下のキーワードが含まれるか判定：

```python
keywords = ["小児", "こども", "子供", "キッズ", "矯正", "Kids"]
if any(kw in display_name for kw in keywords):
    # 対象医院
```

**メリット**:
- シンプル
- API呼び出し後の後処理で実装可能

**デメリット**:
- 医院名に「小児歯科」と記載していない医院は除外される
- 例: 「田中歯科クリニック」（実際は小児歯科も診療）→ 除外される

---

#### 方法3: ウェブサイトスクレイピング（高精度・別途開発）

`websiteUri` を取得後、ウェブサイトの内容を解析：

```python
if "小児歯科" in website_content or "矯正歯科" in website_content:
    # 対象医院
```

**メリット**:
- 最も正確
- 診療科目の詳細情報を取得可能

**デメリット**:
- ウェブサイトが取得できない医院は除外（約20%）
- スクレイピング処理が必要（追加開発）
- APIコスト以外の処理時間がかかる

---

## 推奨実装方法

### Step 1: 検索クエリで絞り込み

複数の検索パターンを実行：

```python
queries = [
    "小児歯科 東京都",
    "矯正歯科 東京都",
    "小児歯科 大阪府",
    "矯正歯科 大阪府",
    # ...全都道府県（45都府県）× 2パターン = 90クエリ
]
```

**問題点**: クエリ数が多すぎる（45都府県 × 2パターン = 90回のAPI呼び出し）

---

### Step 2: 医院名 + 住所で絞り込み（推奨）

既存の65,000件の医院リストがある前提で：

1. **Places Text Search** で各医院を検索（通常通り）
2. **後処理で以下をフィルタリング**:
   - `formattedAddress` に「北海道」「沖縄」を含む → 除外
   - `userRatingCount < 50` → 除外
   - `rating < 3.0` → 除外
   - `displayName` に「小児」「矯正」「子供」「キッズ」を含まない → 除外

**メリット**:
- 既存の処理フローに後処理を追加するだけ
- シンプル

**デメリット**:
- 医院名に「小児歯科」と記載していない医院は除外される

---

### Step 3: 追加フィルタ（オプション）

ウェブサイトが取得できた医院のみ、診療科目を詳細チェック：

```python
if website_uri:
    # ウェブサイトをスクレイピング
    if "小児歯科" in content or "矯正歯科" in content:
        # 対象医院
```

---

## コスト影響

### パターンA: 全65,000件を取得 → 後処理でフィルタ

```
API呼び出し: 65,000件
総コスト: 約51万円（1件のみ取得の場合）

フィルタ後の残存率:
- 北海道・沖縄除外: -5% → 61,750件
- レビュー50件以上: -70% → 18,525件
- 評価3.0以上: -10% → 16,672件
- 小児・矯正歯科: -80% → 3,334件

最終取得数: 約3,000〜5,000件
実質コスト/件: 約100〜170円（51万円 / 3,000件）
```

**無駄が多い**: 65,000件APIを呼び出しても、最終的に3,000件しか残らない

---

### パターンB: 検索クエリで事前絞り込み（推奨）

```
検索クエリ: "小児歯科 [都道府県]", "矯正歯科 [都道府県]"
1クエリあたり最大5件取得

45都府県 × 2パターン = 90クエリ
最大取得数: 90 × 5 = 450件

総コスト: 90クエリ × $0.040 + 450件 × $0.017 = $3.6 + $7.65 = $11.25（約1,630円）
```

**コスト削減率: 99.7%**（51万円 → 1,630円）

---

## テスト実装

実際にどれくらい絞り込めるか確認するテストを実行します。
