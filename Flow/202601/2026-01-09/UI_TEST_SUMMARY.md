# Chrome拡張UIテスト検証シナリオ - 実行サマリー

**作成日**: 2026-01-09
**対象**: Chrome MCP（Model Context Protocol）を使用したUIテスト自動化
**実行時間**: 約10分（並列実行時 ~2分）
**品質ゲート**: 70点/100点以上で統合OK

---

## 概要

このドキュメントは、Chrome拡張MCPツールを使用したUI自動テストの検証シナリオ5パターンを定義・実行するためのガイドです。

**対象5シナリオ**:
1. **ログインフロー検証** - 認証＆ページ遷移
2. **フォーム送信検証** - マルチフィールドフォーム＋バックエンド検証
3. **ページ遷移検証** - リンク遷移＆戻る動作＆URL確認
4. **Ajax/非同期処理検証** - ネットワークレベル確認＆UI動的更新
5. **エラーハンドリング検証** - エラー表示＆リトライ＆バリデーション

---

## ファイル構成

```
Flow/202601/2026-01-09/
├── ui_verification_scenarios.json          ← 検証シナリオ定義（5パターン）
├── ui_verification_implementation_guide.md ← 実装ガイド＆実行方法
├── UI_TEST_SUMMARY.md                      ← このファイル
└── ui_verification/
    ├── screenshots/                        ← テスト実行中のスクリーンショット
    ├── ui_verification_report.md           ← テスト実行後のレポート
    └── ui_verification_scores.json         ← スコア＆判定結果
```

---

## シナリオ詳細

### 1️⃣ ログインフロー検証（Scenario 001）

**検証内容**: ユーザーが正常にログイン → ダッシュボード遷移

| 項目 | 詳細 |
|------|------|
| **URL** | http://localhost:3000/login |
| **ステップ数** | 14ステップ |
| **使用ツール** | navigate, find, form_input, computer, read_page |
| **実行時間** | 30-60秒 |
| **タイムアウト** | 60秒（リトライ2回） |
| **成功基準** | ページ遷移成功＆ダッシュボード表示 |

**成功配点（100点）**:
```
ページ遷移成功      : 20点
フォーム入力成功    : 15点
ボタンクリック成功  : 10点
エラーメッセージ    : 15点
ビジュアル品質      : 25点
レスポンス時間      : 15点
```

**テストデータ**:
- Email: `test@example.com`
- Password: `testpass123`

---

### 2️⃣ フォーム送信検証（Scenario 002）

**検証内容**: 複数フィールドのフォーム送信 → バックエンド検証

| 項目 | 詳細 |
|------|------|
| **URL** | http://localhost:3000/settings/profile-edit |
| **ステップ数** | 16ステップ |
| **使用ツール** | navigate, find, form_input, read_page, javascript_tool |
| **実行時間** | 30-60秒 |
| **タイムアウト** | 80秒（リトライ2回） |
| **成功基準** | フォーム送信成功＆APIレスポンス 200 |

**成功配点（100点）**:
```
複数フィールド入力  : 20点
フォーム送信成功    : 25点
バックエンド処理    : 20点
ユーザーフィードバック: 15点
フォーム検証        : 15点
レスポンス時間      : 5点
```

**入力フィールド**:
- 名前: `田中太郎`
- メール: `tanaka@example.com`
- 電話: `09012345678`

**バリデーションテスト**:
- 無効なメール入力 → エラー表示確認
- 必須フィールド未入力 → エラー表示確認

---

### 3️⃣ ページ遷移検証（Scenario 003）

**検証内容**: 複数ページ間のリンク遷移 → URL確認 → 戻る動作

| 項目 | 詳細 |
|------|------|
| **開始URL** | http://localhost:3000/dashboard |
| **ステップ数** | 17ステップ |
| **使用ツール** | navigate, find, computer, read_page |
| **実行時間** | 30-60秒 |
| **タイムアウト** | 90秒（リトライ2回） |
| **成功基準** | 全遷移成功＆URL正合性 |

**成功配点（100点）**:
```
初期ページ読み込み  : 15点
リンク遷移（1回目） : 20点
詳細ページ遷移      : 20点
戻るボタン機能      : 20点
ページ遷移時間      : 15点
ビジュアル整合性    : 10点
```

**ナビゲーション経路**:
```
Dashboard
  ↓ [Projects link]
Projects List
  ↓ [First Project]
Project Details
  ↓ [Back button]
Projects List
```

**URL検証チェックリスト**:
- [ ] Step 1後: `localhost:3000/dashboard`
- [ ] Step 2後: `localhost:3000/projects`
- [ ] Step 3後: `localhost:3000/projects/{id}`
- [ ] Step 4後: `localhost:3000/projects` (戻る)

---

### 4️⃣ Ajax/非同期処理検証（Scenario 004）

**検証内容**: Ajax呼び出し → ネットワークレベル確認 → UI動的更新

| 項目 | 詳細 |
|------|------|
| **URL** | http://localhost:3000/analytics/realtime |
| **ステップ数** | 15ステップ |
| **使用ツール** | navigate, find, computer, read_network_requests, javascript_tool |
| **実行時間** | 30-60秒 |
| **タイムアウト** | 60秒（リトライ不可） |
| **成功基準** | Ajax成功＆UIリアルタイム更新 |

**成功配点（100点）**:
```
Ajax呼び出し成功    : 25点
UIの更新確認        : 20点
ローディング状態    : 15点
エラーなし          : 20点
データ更新確認      : 15点
パフォーマンス      : 5点
```

**パフォーマンス基準**:
```
┌─────────────────────────────────────────────────────┐
│ Ajax応答時間                                        │
├──────────────────┬──────────────┬──────────────────┤
│ < 2秒 (目標)     │ 1.5-3秒 ⚠️   │ > 3秒 ❌ (NG)   │
├──────────────────┼──────────────┼──────────────────┤
│ UI更新 < 500ms   │ 500ms-2秒 ⚠️ │ > 2秒 ❌ (NG)   │
└──────────────────┴──────────────┴──────────────────┘
```

**ネットワークリクエスト確認**:
- [x] HTTP 200 レスポンス
- [x] `/api/analytics` エンドポイント
- [x] JSON形式のレスポンス

---

### 5️⃣ エラーハンドリング検証（Scenario 005）

**検証内容**: エラー発生時のUI反応 → エラーメッセージ → リトライ機能

| 項目 | 詳細 |
|------|------|
| **URL** | http://localhost:3000/dashboard |
| **ステップ数** | 20ステップ |
| **使用ツール** | navigate, find, computer, javascript_tool, read_console_messages |
| **実行時間** | 30-60秒 |
| **タイムアウト** | 90秒（リトライ不可） |
| **成功基準** | エラー表示＆リトライ成功 |

**成功配点（100点）**:
```
エラーメッセージ表示: 20点
メッセージ明確性    : 15点
リトライボタン表示  : 15点
リトライ機能動作    : 20点
バリデーションエラー: 15点
エラー堅牢性        : 15点
```

**テストされるエラーシナリオ**:
```
┌─────────────────────────────────────────────────────┐
│ エラーシナリオ                                      │
├──────────────────┬──────────────┬──────────────────┤
│ API 500エラー    │ リトライ     │ 成功復帰チェック │
├──────────────────┼──────────────┼──────────────────┤
│ ネットワーク     │ オフライン表示│ 再接続確認      │
│ タイムアウト     │              │                 │
├──────────────────┼──────────────┼──────────────────┤
│ バリデーション   │ フィールド別  │ エラー下部表示  │
│ エラー           │ メッセージ    │ フォーカス移動  │
└──────────────────┴──────────────┴──────────────────┘
```

**エラー表示基準（WCAG準拠）**:
- ✅ エラーの原因が明確
- ✅ ユーザーが実行できるアクション提示
- ✅ サポートリンク（メール・フォーム）含有
- ✅ 技術的なスタックトレースは非表示
- ✅ 赤色＋アイコンで識別（色のみでなく）
- ✅ コントラスト比 WCAG AA準拠
- ✅ スクリーンリーダー対応

---

## Chrome拡張MCPツール使用マトリックス

| ツール | Scenario 1 | Scenario 2 | Scenario 3 | Scenario 4 | Scenario 5 |
|--------|:----------:|:----------:|:----------:|:----------:|:----------:|
| **tabs_context_mcp** | ✅ | ✅ | ✅ | ✅ | ✅ |
| **tabs_create_mcp** | ✅ | ✅ | ✅ | ✅ | ✅ |
| **navigate** | ✅ | ✅ | ✅ | ✅ | ✅ |
| **find** | ✅ | ✅ | ✅ | ✅ | ✅ |
| **form_input** | ✅ | ✅ | ❌ | ❌ | ❌ |
| **computer (screenshot)** | ✅ | ✅ | ✅ | ✅ | ✅ |
| **computer (click)** | ✅ | ✅ | ✅ | ✅ | ✅ |
| **computer (wait)** | ✅ | ✅ | ✅ | ✅ | ✅ |
| **read_page** | ✅ | ✅ | ✅ | ✅ | ✅ |
| **javascript_tool** | ❌ | ✅ | ❌ | ✅ | ✅ |
| **read_network_requests** | ❌ | ❌ | ❌ | ✅ | ❌ |
| **read_console_messages** | ❌ | ❌ | ❌ | ✅ | ✅ |
| **resize_window** | ✅ | ✅ | ✅ | ✅ | ✅ |

---

## 実行フロー図

```
┌─────────────────────────────────────────────────────────┐
│ Phase 1: 環境セットアップ (3分)                         │
├─────────────────────────────────────────────────────────┤
│ ① Chrome拡張接続 (tabs_context_mcp)                    │
│ ② テストアカウント初期化                               │
│ ③ テストタブ作成 (tabs_create_mcp)                    │
│ ④ ウィンドウサイズ設定 (1920x1080)                   │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│ Phase 2: シナリオ実行 (7-8分)                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  [並列実行が可能]                                       │
│  ├─ Scenario 1: ログイン (1-2分)                       │
│  ├─ Scenario 2: フォーム (1-2分)  ─┐                   │
│  └─ Scenario 3: ページ遷移 (1-2分) ┤ 3並列実行       │
│                                     │ 最長: ~2分      │
│  [順序必須]                         │                 │
│  └─ Scenario 1 完了後のみ ─────────┘                   │
│     ├─ Scenario 4: Ajax (1-2分)                        │
│     └─ Scenario 5: エラー (1-2分)                      │
│                                                         │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│ Phase 3: レポート生成 & 品質判定 (2-3分)               │
├─────────────────────────────────────────────────────────┤
│ ① スコア集計 (5シナリオ × 100点 = 500点満点)         │
│ ② 品質ゲート判定 (70点/シナリオ、350点/総合)        │
│ ③ マークダウンレポート生成                           │
│ ④ JSONスコア保存                                      │
│ ⑤ スクリーンショット保存                             │
└─────────────────────────────────────────────────────────┘

総実行時間: 10分 (順序実行) ⟹ 2-3分 (3並列 + 順序)
```

---

## 品質ゲート判定基準

### シナリオ別判定

```
┌────────────────────────────────────────────────────┐
│ 各シナリオ (100点満点)                              │
├────────────────────────────────────────────────────┤
│ 70点以上 ✅ PASS   → 合格                         │
│ 60-69点  ⚠️ WARN   → 条件付き合格              │
│ 60点未満 ❌ FAIL   → 不合格 (再検証必須)         │
└────────────────────────────────────────────────────┘
```

### 総合判定

```
┌────────────────────────────────────────────────────┐
│ 総合スコア (500点満点)                              │
├────────────────────────────────────────────────────┤
│ 420-500  🟢 優秀                                  │
│ 350-419  🟡 合格                                  │
│ 0-349    🔴 要改善                                │
└────────────────────────────────────────────────────┘

推奨アクション:
├─ 🟢 優秀 (420+):  本番環境への統合推奨
├─ 🟡 合格 (350+):  統合OK、改善点を記録
└─ 🔴 要改善 (<350): UI修正後に再検証
```

---

## 実行時間統計

### シナリオ別実行時間

| シナリオ | 標準時間 | 最大時間 | タイムアウト |
|---------|---------|---------|------------|
| Scenario 1 (ログイン) | 40秒 | 60秒 | 60秒 |
| Scenario 2 (フォーム) | 45秒 | 70秒 | 80秒 |
| Scenario 3 (ページ遷移) | 50秒 | 75秒 | 90秒 |
| Scenario 4 (Ajax) | 35秒 | 55秒 | 60秒 |
| Scenario 5 (エラー) | 50秒 | 80秒 | 90秒 |
| **順序実行計** | **3-4分** | **6分** | - |
| **3並列実行** | **1.5-2分** | **3分** | - |

### スクリーンショット枚数

```
Scenario 1: 2-3枚   (初期、操作中、結果)
Scenario 2: 2-3枚   (初期、送信前、結果)
Scenario 3: 4枚     (各遷移ステップ)
Scenario 4: 3枚     (初期、動作中、結果)
Scenario 5: 4-5枚   (エラー、リトライ、検証)
────────────────────────────
合計: 15-18枚
```

---

## 依存関係と実行順序

```
┌─────────────────────────────────────────────────┐
│ Scenario 1 (ログイン)                           │
│  ↓必須前提条件                                  │
│  (ユーザーログイン)                              │
│  ↓                                              │
├─ Scenario 2 (フォーム)  ──┐ 並列可能            │
├─ Scenario 3 (ページ遷移) ──┤ (Scenario 1後)    │
│                          ↓                      │
│ ┌─────────────────────────────────────────────┐│
│ │ Scenario 4 (Ajax)     ──┐ 並列可能           ││
│ │ Scenario 5 (エラー)    ──┘ (Scenario 1/2/3後)││
│ └─────────────────────────────────────────────┘│
└─────────────────────────────────────────────────┘

推奨実行パターン:
┌─ グループA (並列開始) ─────────┐
│  Scenario 1 (60秒)              │
│  ↓ 完了後                       │
│  ┌─ グループB (並列) ──┐       │
│  │  Scenario 2 (70秒)  │ 70秒  │
│  │  Scenario 3 (75秒)  │       │
│  └─────────────────────┘       │
│  ↓ 完了後                       │
│  ┌─ グループC (並列) ──┐       │
│  │  Scenario 4 (55秒)  │ 80秒  │
│  │  Scenario 5 (80秒)  │       │
│  └─────────────────────┘       │
└─────────────────────────────────┘

総実行時間: 60 + 75 + 80 = 215秒 (≈3.5分)
```

---

## エラーハンドリング戦略

### 標準リトライポリシー

```yaml
Scenario 1 (ログイン):
  retry_on_failure: true
  max_retries: 2
  recovery_action: "ブラウザリロード + 再ログイン"

Scenario 2 (フォーム):
  retry_on_failure: true
  max_retries: 2
  recovery_action: "フォーム入力リセット + 再送信"

Scenario 3 (ページ遷移):
  retry_on_failure: true
  max_retries: 2
  recovery_action: "ブラウザ戻る → 再クリック"

Scenario 4 (Ajax):
  retry_on_failure: false
  max_retries: 0
  recovery_action: "スキップ＆ログ記録"

Scenario 5 (エラー):
  retry_on_failure: false
  max_retries: 0
  recovery_action: "スキップ＆ログ記録"
```

### 一般的なエラーと対応

| エラー | 原因 | 対応 |
|--------|------|------|
| 401 Authentication | OAuth token期限切れ | Chrome拡張再起動 |
| 404 Not Found | ページが存在しない | テスト環境確認 |
| Timeout | サーバー応答遅延 | ネットワーク確認 |
| Element Not Found | DOM未生成 | 待機時間増加 |
| CSP Error | Content Security Policy | JavaScript実行スキップ |

---

## 出力ファイル

### 1. テスト実行レポート

**ファイル**: `ui_verification_report.md`

```markdown
# UIテスト検証レポート

**実行日時**: 2026-01-09 10:00:00
**テスト環境**: http://localhost:3000
**ブラウザ**: Chrome 1920x1080
**実行時間**: 約3.5分

## 検証結果サマリー

| シナリオ | スコア | 判定 |
|---------|--------|------|
| Scenario 1 | 85/100 | ✅ |
| Scenario 2 | 92/100 | ✅ |
| Scenario 3 | 78/100 | ✅ |
| Scenario 4 | 88/100 | ✅ |
| Scenario 5 | 81/100 | ✅ |
| **総合** | **424/500** | **優秀** |

[詳細結果...]
```

### 2. スコア JSON

**ファイル**: `ui_verification_scores.json`

```json
{
  "timestamp": "2026-01-09T10:00:00Z",
  "total_score": 424,
  "average_score": 84.8,
  "quality_level": "優秀",
  "passing_score": 350,
  "scenarios": {
    "scenario_001_login": 85,
    "scenario_002_form": 92,
    "scenario_003_navigation": 78,
    "scenario_004_ajax": 88,
    "scenario_005_error": 81
  }
}
```

### 3. スクリーンショット

**ディレクトリ**: `ui_verification/screenshots/`

```
scenario_001_01_login_page_initial.jpeg
scenario_001_02_login_form_filled.jpeg
scenario_001_03_dashboard_success.jpeg
scenario_002_01_profile_form_initial.jpeg
scenario_002_02_form_filled.jpeg
scenario_002_03_success_message.jpeg
...（計15-18枚）
```

---

## 使用方法

### Quick Start

```bash
# 1. シナリオファイルを確認
cat ui_verification_scenarios.json

# 2. 実装ガイドを参照
cat ui_verification_implementation_guide.md

# 3. テストを実行（Claude Code内で）
# - tabs_context_mcp() で接続確認
# - 各シナリオのステップを順序実行
# - レポート＆スコアを出力

# 4. 結果確認
cat ui_verification_report.md
cat ui_verification_scores.json
```

### 並列実行（推奨）

```python
# Claude Code内でサブエージェント並列実行
Task(subagent_type="general-purpose", prompt="Scenario 1: ログイン検証")
Task(subagent_type="general-purpose", prompt="Scenario 2: フォーム検証")
Task(subagent_type="general-purpose", prompt="Scenario 3: ページ遷移検証")

# 結果集約
Task(subagent_type="general-purpose", prompt="Scenario 4/5 実行＆レポート生成")
```

---

## ベストプラクティス

✅ **推奨**:
- [ ] スクリーンショットは各ステップで記録
- [ ] エラー発生時はコンソールログを確認
- [ ] ネットワークリクエストもレポートに含める
- [ ] テスト結果は JSON + Markdown の両形式で保存
- [ ] 定期的（週1回）にUIテストを実行

❌ **非推奨**:
- [ ] JavaScriptアラート/確認ダイアログをトリガー
- [ ] 同じ操作を3回以上繰り返す
- [ ] 前回セッションのタブIDを再利用
- [ ] ハードコードされたパスを使用

---

## 参照ファイル

- **検証シナリオ定義**: `ui_verification_scenarios.json` (800+ 行)
- **実装ガイド**: `ui_verification_implementation_guide.md` (500+ 行)
- **Chrome拡張ガイド**: `@docs/implementation_guides/week1_ui_testing.md`
- **LLM優先ルール**: `@.claude/rules/execution_preference.md`
- **並列実行ガイド**: `@.claude/rules/parallel_execution.md`

---

## FAQ

**Q1: テストに失敗した場合はどうする？**

A: スコアが 70 点未満の場合は、以下の対応を推奨：
1. エラーログを確認（read_console_messages）
2. スクリーンショットで視覚的に確認
3. 該当UIコンポーネントを修正
4. 該当シナリオのみ再実行

**Q2: テスト実行時間を短縮できる？**

A: 並列実行により 60% 短縮可能：
- シーケンシャル実行: 約 3-5 分
- 3 並列実行: 約 1.5-2 分

**Q3: Chrome拡張接続エラーが出た場合は？**

A: OAuth token 期限切れの可能性：
1. Chrome拡張を再起動
2. `tabs_context_mcp(createIfEmpty=True)` を再実行

**Q4: スクリーンショットが空白の場合は？**

A: ページ読み込み未完了の可能性：
```python
computer(tabId=tab_id, action="wait", duration=5)  # 待機時間増加
screenshot_id = computer(tabId=tab_id, action="screenshot")
```

**Q5: 本番環境でも実行できる？**

A: 実行可能ですが、テスト専用アカウント＆テストデータを使用してください。本番ユーザーデータへのアクセスは厳禁です。

---

## チェックリスト

### テスト実行前
- [ ] テスト環境（localhost:3000）が起動している
- [ ] テストアカウント（test@example.com）が存在する
- [ ] ブラウザクッキーがクリアされている
- [ ] Chrome拡張が有効になっている
- [ ] ネットワークが接続されている

### テスト実行後
- [ ] 全 5 シナリオが完了した
- [ ] スコアが 100 ～ 500 の範囲内
- [ ] レポート（.md + .json）が生成された
- [ ] スクリーンショットが保存された
- [ ] 品質ゲート判定が実施された

---

**Created**: 2026-01-09
**Version**: 1.0
**Status**: ✅ Ready for Use

作成: Claude Code UI Testing Automation
